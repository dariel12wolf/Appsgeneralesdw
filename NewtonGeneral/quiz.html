<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quiz X-Academy</title>
    <link href="https://fonts.googleapis.com/css2?family=Titan+One&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* CORRECCI√ìN RESPONSIVE */
        * { box-sizing: border-box; }
        :root { --red:#ff3b5c; --blue:#0099ff; --yellow:#ffcc00; --green:#26890c; --bg:#eef2f5; }
        
        body { 
            font-family:'Nunito',sans-serif; background:var(--bg); margin:0; 
            height:100vh; width:100vw; overflow:hidden; 
            user-select:none; display:flex; flex-direction:column; 
        }

        /* PANTALLAS */
        .screen { position:absolute; top:0; left:0; width:100%; height:100%; background:var(--bg); display:flex; flex-direction:column; align-items:center; justify-content:center; transition:0.3s; z-index:10; overflow-y:auto; padding-bottom:20px; }
        .hidden { opacity:0; pointer-events:none; z-index:-1; }

        /* LOBBY */
        #introScreen { background-image: radial-gradient(#ddd 15%, transparent 16%); background-size:20px 20px; }
        .logo-box { position:relative; margin-bottom:10px; animation:float 3s infinite ease-in-out; }
        .logo-text { font-family:'Titan One'; font-size:50px; color:white; -webkit-text-stroke:2px black; text-shadow:4px 4px 0 #000; background:var(--blue); padding:5px 25px; border-radius:15px; border:4px solid white; transform:rotate(-3deg); box-shadow:0 8px 0 #0056b3; }
        
        .char-img { height:200px; object-fit:contain; margin:15px 0; filter:drop-shadow(0 10px 5px rgba(0,0,0,0.1)); transition:0.3s; }
        
        .rules-bar { display:flex; gap:15px; background:white; padding:8px 20px; border-radius:50px; font-weight:900; color:#555; box-shadow:0 4px 10px rgba(0,0,0,0.05); margin-bottom:25px; font-size:16px; }
        .btn-play { background:var(--blue); color:white; border:none; padding:12px 50px; border-radius:50px; font-size:22px; font-family:'Titan One'; cursor:pointer; border:4px solid white; box-shadow:0 6px 0 #0056b3, 0 10px 20px rgba(0,0,0,0.2); transition:0.1s; }
        .btn-play:active { transform:translateY(6px); box-shadow:none; }

        /* JUEGO */
        #gameScreen { background:white; justify-content:flex-start; }
        .timer-bg { width:100%; height:10px; background:#eee; }
        .timer-fill { height:100%; background:var(--blue); width:100%; transition:width 1s linear; }
        
        .top-bar { width:100%; display:flex; justify-content:space-between; align-items:center; padding:15px 20px; font-weight:900; font-size:18px; color:#444; background:#fff; box-shadow:0 2px 10px rgba(0,0,0,0.05); z-index:5; flex-shrink: 0; }
        .progress-badge { background:#eee; padding:5px 15px; border-radius:20px; font-size:14px; color:#666; }

        .q-area { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:10px; text-align:center; width:100%; overflow-y:auto; }
        .q-img { max-height:22vh; max-width:90%; border-radius:10px; margin-bottom:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1); object-fit: contain; }
        .q-text { font-size:18px; font-weight:800; color:#333; margin:0; line-height: 1.4; }
        
        .ans-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; width:100%; padding:15px; height:35vh; flex-shrink: 0; }
        .ans-btn { border:none; border-radius:12px; color:white; font-weight:800; font-size:14px; cursor:pointer; box-shadow:0 4px 0 rgba(0,0,0,0.2); transition:0.1s; padding:5px; display:flex; align-items:center; justify-content:center; }
        .ans-btn:active { transform:translateY(4px); box-shadow:none; }
        .b-0 { background:var(--red); } .b-1 { background:var(--blue); } .b-2 { background:var(--yellow); } .b-3 { background:var(--green); }

        /* FEEDBACK (Con Emote) */
        #msgOverlay { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:none; flex-direction:column; align-items:center; justify-content:center; color:white; font-size:35px; font-family:'Titan One'; z-index:50; }
        .emote-feedback { width: 150px; height: 150px; border-radius: 50%; border: 5px solid white; margin-bottom: 20px; object-fit: cover; background: white; }

        /* RESULTADOS */
        #resScreen { background:white; }
        .res-score { font-size:80px; font-family:'Titan One'; color:var(--blue); margin:10px 0; text-shadow:3px 3px 0 #ddd; }

        /* MODALES (DISE√ëO MEJORADO) */
        .modal-overlay { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:100; display:none; align-items:center; justify-content:center; }
        .modal-box { background:white; width:90%; max-height:80%; border-radius:20px; padding:20px; overflow-y:auto; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.3); }
        
        /* RANKING LIST DESIGN */
        .rank-item { 
            display:flex; justify-content:space-between; align-items:center;
            padding:12px; margin-bottom: 8px;
            background: #f9f9f9; border-radius: 12px;
            border-left: 4px solid #ddd;
            font-weight:bold; color:#555; 
        }
        .rank-pos { 
            width:35px; height:35px; background:#fff; 
            border-radius:50%; display:flex; justify-content:center; 
            align-items:center; margin-right:15px; font-size:16px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-weight: 900;
        }
        .rank-1 { background:linear-gradient(135deg, #ffd700, #ffaa00); color:white; border-color: #ffd700; }
        .rank-2 { background:linear-gradient(135deg, #c0c0c0, #999); color:white; border-color: #c0c0c0; }
        .rank-3 { background:linear-gradient(135deg, #cd7f32, #a05a2c); color:white; border-color: #cd7f32; }
        
        /* Highlight para Top 3 en la lista */
        .rank-item:nth-child(1) { border-left-color: #ffd700; background: #fffdf0; }
        .rank-item:nth-child(2) { border-left-color: #c0c0c0; background: #f4f4f4; }
        .rank-item:nth-child(3) { border-left-color: #cd7f32; background: #fff5eb; }

        .review-item { text-align:left; border-bottom:1px solid #eee; padding:10px 0; font-size:14px; }
        .tag-ans { display:inline-block; padding:2px 8px; border-radius:4px; color:white; font-size:11px; margin-right:5px; font-weight:bold; }
        .tag-correct { background:var(--green); } .tag-wrong { background:var(--red); }

        @keyframes float { 0%,100% {transform:translateY(0);} 50% {transform:translateY(-8px);} }
    </style>
</head>
<body>

    <div id="introScreen" class="screen">
        <div class="logo-box">
            <div class="logo-text">X-QUIZ</div>
        </div>
        <img src="" class="char-img" id="charImg"> 
        <div id="quizTitle" style="font-family:'Titan One'; font-size:20px; color:#555; margin-bottom:15px; text-align:center; padding:0 20px;">Cargando...</div>
        <div class="rules-bar">
            <span style="color:var(--green)">‚úÖ <span id="ptsWin">+20</span></span>
            <span style="color:var(--red)">‚ùå <span id="ptsLose">-5</span></span>
        </div>
        <button class="btn-play" onclick="startGame()">JUGAR</button>
        <p id="errorMsg" style="color:red; font-size:12px; margin-top:10px; display:none;"></p>
    </div>

    <div id="gameScreen" class="screen hidden">
        <div class="timer-bg"><div id="timeBar" class="timer-fill"></div></div>
        <div class="top-bar">
            <div id="scoreTxt">PTS: 0</div>
            <div id="progressTxt" class="progress-badge">1/10</div> 
            <div style="color:var(--red)" id="livesTxt">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        </div>
        <div class="q-area">
            <img id="qImg" class="q-img" style="display:none">
            <p id="qTxt" class="q-text">...</p>
        </div>
        <div class="ans-grid" id="ansBox"></div>
    </div>

    <div id="msgOverlay">
        <img id="msgEmote" src="" class="emote-feedback">
        <div id="msgTxt">¬°BIEN!</div>
    </div>

    <div id="resScreen" class="screen hidden">
        <img id="resEmote" src="" style="width:120px; height:120px; border-radius:50%; object-fit:cover; border:5px solid var(--blue); margin-bottom:10px;">
        <h2 style="color:#555; margin:0;">PUNTAJE</h2>
        <div id="finalScore" class="res-score">0</div>
        
        <div style="background:#f4f6f9; padding:10px 20px; border-radius:15px; width:80%; margin-bottom:15px;">
            <div id="xpResult" style="font-weight:bold; color:var(--blue); font-size:18px;">+0 XP</div>
            <div id="recordMsg" style="font-size:12px; color:#888;"></div>
        </div>
        
        <div style="display:flex; flex-direction:column; gap:10px; width:80%;">
            <button class="btn-play" onclick="openReview()" style="font-size:14px; background:#fff; color:#555; border-color:#eee; padding:10px;">üëÅÔ∏è VER SOLUCIONARIO</button>
            <button class="btn-play" onclick="showRanking()" style="font-size:14px; background:var(--yellow); border-color:#e6b800; padding:10px;">üèÜ RANKING GLOBAL</button>
            <button class="btn-play" onclick="history.back()" style="font-size:14px; padding:10px;">VOLVER AL MAPA</button>
        </div>
    </div>

    <div id="rankModal" class="modal-overlay">
        <div class="modal-box">
            <h2 style="color:var(--blue); margin-top:0;">üèÜ TOP 10</h2>
            <p id="rankLoading">Cargando...</p>
            <div id="rankList" style="text-align: left;"></div>
            <button onclick="document.getElementById('rankModal').style.display='none'" style="margin-top:20px; padding:10px 30px; border:none; background:#eee; border-radius:20px; font-weight:bold;">Cerrar</button>
        </div>
    </div>

    <div id="reviewModal" class="modal-overlay">
        <div class="modal-box" style="text-align:left;">
            <h2 style="color:#333; margin-top:0; text-align:center;">Solucionario</h2>
            <div id="reviewList"></div>
            <button onclick="document.getElementById('reviewModal').style.display='none'" style="margin-top:20px; width:100%; padding:12px; border:none; background:var(--blue); color:white; border-radius:15px; font-weight:bold;">Cerrar</button>
        </div>
    </div>

    <script src="banco_preguntas.js"></script>
    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxWaxV806RNSGlxwO-fc74hQ347UczAQl9YhZvPqNsRdmib6Qp2ySjfgTeIWiWIvqCY9w/exec";
        
        // --- POOLS DE EMOTES (MEZCLADOS) ---
        const EMOTE_POOLS = {
            // Emotes para el inicio (Saludando / Se√±alando)
            intro: [
                'img/emotes/se√±alar.png', 
                'img/emotes/se√±alaremotechica.png',
                'img/emotes/se√±alando2emotechica.png' 
            ],
            // Emotes para Acierto / Ganar (Feliz / Like)
            happy: [
                'img/emotes/chibilike.png', 
                'img/emotes/feliz.png', 
                'img/emotes/chibilikeemotechica.png', 
                'img/emotes/jejetimidoemotechica.png',
                'img/emotes/hablaremotechica.png',
                'img/emotes/jejetimido.png'
            ],
            // Emotes para Error / Duda (Pensando / Leyendo)
            sad: [
                'img/emotes/duda.png', 
                'img/emotes/leyendo.png',
                'img/emotes/dudaemotechica.png', 
                'img/emotes/leyendoemotechica.png'
            ]
        };

        // Funci√≥n para obtener emote aleatorio de una categor√≠a
        function getRandomEmote(category) {
            const pool = EMOTE_POOLS[category];
            return pool[Math.floor(Math.random() * pool.length)];
        }

        // --- L√ìGICA DEL JUEGO ---
        let data, idx=0, score=0, lives=3, timer, time=0, currentQuizID="";
        let userResponses = [];

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            currentQuizID = params.get('id');

            // Cargar Avatar Aleatorio de Inicio
            document.getElementById('charImg').src = getRandomEmote('intro');

            if(typeof bancoPreguntas !== 'undefined' && currentQuizID && bancoPreguntas[currentQuizID]) {
                data = bancoPreguntas[currentQuizID];
                document.getElementById('quizTitle').innerText = data.titulo;
                document.getElementById('ptsWin').innerText = "+" + data.reglas.acierto;
                document.getElementById('ptsLose').innerText = data.reglas.fallo;
            } else {
                document.getElementById('errorMsg').innerText = "‚ö†Ô∏è Quiz no encontrado";
                document.getElementById('errorMsg').style.display = 'block';
                document.querySelector('.btn-play').style.display = 'none';
            }
        });

        function startGame() {
            document.getElementById('introScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            idx=0; score=0; lives=3; userResponses=[];
            loadQ();
        }

        function loadQ() {
            if(idx >= data.preguntas.length || lives <= 0) return endGame();
            
            const q = data.preguntas[idx];
            document.getElementById('progressTxt').innerText = `${idx + 1}/${data.preguntas.length}`;
            document.getElementById('qTxt').innerText = q.texto;
            const img = document.getElementById('qImg');
            if(q.img) { img.src=q.img; img.style.display='block'; } else { img.style.display='none'; }
            
            const grid = document.getElementById('ansBox');
            grid.innerHTML = '';
            q.opciones.forEach((o, i) => {
                grid.innerHTML += `<button class="ans-btn b-${i}" onclick="check(${i})">${o}</button>`;
            });
            
            time = q.tiempo || 20;
            startTimer();
        }

        function startTimer() {
            clearInterval(timer);
            const bar = document.getElementById('timeBar');
            bar.style.transition = 'none'; bar.style.width = '100%';
            void bar.offsetWidth; 
            bar.style.transition = `width ${time}s linear`; 
            bar.style.width = '0%'; 
            
            timer = setInterval(() => { time--; if(time <= 0) check(-1); }, 1000);
        }

        function check(i) {
            clearInterval(timer);
            const bar = document.getElementById('timeBar');
            bar.style.transition = 'none'; bar.style.width = getComputedStyle(bar).width;

            const q = data.preguntas[idx];
            let isOk = (i === q.correcta);
            
            userResponses.push({ texto: q.texto, elegida: i, correcta: q.correcta, opciones: q.opciones });

            if(isOk) { 
                score += data.reglas.acierto; 
                showMsg('¬°BIEN!', true); 
            } else { 
                score += data.reglas.fallo; 
                if(score < 0) score = 0; 
                lives--; updateHearts(); 
                showMsg(i===-1 ? '¬°TIEMPO!' : '¬°MAL!', false); 
            }
            document.getElementById('scoreTxt').innerText = "PTS: " + score;
        }

        function showMsg(txt, ok) {
            const ov = document.getElementById('msgOverlay');
            const emote = document.getElementById('msgEmote');
            
            ov.style.display = 'flex';
            ov.style.background = ok ? 'rgba(38,137,12,0.9)' : 'rgba(255,59,92,0.9)';
            
            // EMOTE ALEATORIO SEG√öN RESULTADO
            emote.src = ok ? getRandomEmote('happy') : getRandomEmote('sad');
            
            document.getElementById('msgTxt').innerText = txt;
            setTimeout(() => { ov.style.display = 'none'; idx++; loadQ(); }, 1500);
        }

        function updateHearts() {
            let h = ""; for(let k=0; k<lives; k++) h += "‚ù§Ô∏è";
            document.getElementById('livesTxt').innerText = h;
        }

        function endGame() {
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('resScreen').classList.remove('hidden');
            document.getElementById('finalScore').innerText = score;
            
            // EMOTE FINAL ALEATORIO
            document.getElementById('resEmote').src = score > 0 ? getRandomEmote('happy') : getRandomEmote('sad');

            const storageKey = `maxScore_${currentQuizID}`;
            const prevHigh = parseInt(localStorage.getItem(storageKey)) || 0;
            let xpToGive = 0;
            let msg = "";

            if (score > prevHigh) {
                const scoreDiff = score - prevHigh;
                xpToGive = Math.floor(scoreDiff * 0.5); 
                localStorage.setItem(storageKey, score);
                msg = `¬°Nuevo R√©cord! (Anterior: ${prevHigh})`;
                if(xpToGive > 0) msg += " - XP Ganada";
            } else {
                xpToGive = 0;
                msg = `Mejor puntaje guardado: ${prevHigh}`;
            }

            document.getElementById('xpResult').innerText = xpToGive > 0 ? `+${xpToGive} XP` : "+0 XP";
            document.getElementById('recordMsg').innerText = msg;

            if(xpToGive > 0) {
                let curXP = parseInt(localStorage.getItem('xAcademy_XP')) || 0;
                localStorage.setItem('xAcademy_XP', curXP + xpToGive);
                
                const parts = currentQuizID.split('_tema');
                if(parts.length === 2 && score > 0) {
                    const curso = parts[0]; 
                    const temaNum = parseInt(parts[1]); 
                    const currentProgress = parseInt(localStorage.getItem(curso + '_progress')) || 1;
                    if(temaNum >= currentProgress) {
                        localStorage.setItem(curso + '_progress', temaNum + 1);
                    }
                }

                let uid = localStorage.getItem('xAcademy_ID');
                if(uid) {
                    const nombreCursoRanking = currentQuizID.split('_')[0]; 
                    const url = `${API_URL}?action=saveXP&id=${uid}&xp=${xpToGive}&curso=${nombreCursoRanking}&actividad=${currentQuizID}`;
                    fetch(url, {mode:'no-cors'});
                }
            }
        }

        function openReview() {
            const list = document.getElementById('reviewList');
            list.innerHTML = "";
            userResponses.forEach((r, i) => {
                const isCorrect = (r.elegida === r.correcta);
                const userAnsText = r.elegida === -1 ? "Tiempo Agotado" : r.opciones[r.elegida];
                const correctAnsText = r.opciones[r.correcta];
                list.innerHTML += `<div class="review-item"><div class="review-q">${i+1}. ${r.texto}</div><div><span class="tag-ans ${isCorrect ? 'tag-correct' : 'tag-wrong'}">${isCorrect ? 'T√∫: ' + userAnsText : 'T√∫: ' + userAnsText}</span>${!isCorrect ? `<span class="tag-ans tag-correct">Correcta: ${correctAnsText}</span>` : ''}</div></div>`;
            });
            document.getElementById('reviewModal').style.display = 'flex';
        }

        function showRanking() {
            document.getElementById('rankModal').style.display = 'flex';
            const nombreCurso = currentQuizID.split('_')[0]; 
            fetch(`${API_URL}?action=getRanking&curso=${nombreCurso}`).then(res => res.json()).then(data => {
                document.getElementById('rankLoading').style.display = 'none';
                const list = document.getElementById('rankList');
                list.innerHTML = "";
                data.forEach((user, i) => {
                    const rankClass = i < 3 ? `rank-${i+1}` : '';
                    list.innerHTML += `
                        <div class="rank-item">
                            <div style="display:flex; align-items:center;">
                                <div class="rank-pos ${rankClass}">${i+1}</div>
                                <span>${user.nombre}</span>
                            </div>
                            <span style="color:var(--blue)">${user.xp} pts</span>
                        </div>
                    `;
                });
            });
        }
    </script>
</body>
</html>